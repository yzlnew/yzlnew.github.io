<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>从通知实现钱迹 Tasker 自动化记账 - yzlnew</title><link rel=icon type=image/png href=/img/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="从通知实现钱迹 Tasker 自动化记账"><meta itemprop=description content="我花过，我记过，我忘了。"><meta itemprop=datePublished content="2020-12-03T20:15:43+08:00"><meta itemprop=dateModified content="2020-12-03T20:15:43+08:00"><meta itemprop=wordCount content="1925"><meta itemprop=keywords content="Tasker,"><meta property="og:title" content="从通知实现钱迹 Tasker 自动化记账"><meta property="og:description" content="我花过，我记过，我忘了。"><meta property="og:type" content="article"><meta property="og:url" content="https://yzlnew.com/2020/12/tasker-with-qianji/"><meta property="article:published_time" content="2020-12-03T20:15:43+08:00"><meta property="article:modified_time" content="2020-12-03T20:15:43+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="从通知实现钱迹 Tasker 自动化记账"><meta name=twitter:description content="我花过，我记过，我忘了。"><link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css><link rel=stylesheet type=text/css media=screen href=https://yzlnew.com/css/main.css><link rel=stylesheet type=text/css href=https://yzlnew.com/css/custom.css><link id=dark-scheme rel=stylesheet type=text/css href=https://yzlnew.com/css/dark.css><link id=dark-scheme rel=stylesheet type=text/css href=https://yzlnew.com/css/custom_dark.css><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=https://yzlnew.com/js/main.js></script><script charset=utf-8>var tabName=document.title;window.onblur=function(){document.title='想回到过去~';}
window.onfocus=function(){document.title=tabName;}</script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://yzlnew.com/><img src=/img/penrose.webp alt=yzlnew></a></div><h1 class=site-title><a href=https://yzlnew.com/>yzlnew</a></h1><div class=site-description><p>👨‍💻</p></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/blog>Tech</a></li><li><a href=/life>Life</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></nav></div><div class=sidebar><nav id=TableOfContents><ul><li><a href=#通知触发-intent>通知触发 Intent</a><ul><li><a href=#复习通知事件>复习通知事件</a></li><li><a href=#发送-intent>发送 Intent</a></li></ul></li><li><a href=#通知触发-deeplink>通知触发 Deeplink</a><ul><li><a href=#deeplink-简介>Deeplink 简介</a></li><li><a href=#钱迹接口>钱迹接口</a></li><li><a href=#操作逻辑>操作逻辑</a></li></ul></li><li><a href=#效果展示>效果展示</a></li><li><a href=#高级玩法>高级玩法</a></li></ul></nav></div><div class=post><article><div class=post-header><div class=matter><h1 class=title>从通知实现钱迹 Tasker 自动化记账</h1><div class=meta><span class=date>2020-12-03</span></div></div></div></article><div class=markdown><p>继上次通过 Tasker 和通知实现机器人之后，决定利用 Tasker 做一些更有效率的事情、解决实际使用手机中的一些痛点。</p><p><img src=https://cdn.sspai.com/2020/07/07/318c33c44af79e0b45e6149ecfbb2f94.png alt></p><p>思来想去，我有一个经常重复的操作是每次支付完都会使用钱迹进行记账，具体步骤无非是「回到桌面 > 打开钱迹/钱迹微件 > 输入金额 > 选择分类 > 记账完成」。</p><p>可是我观察到几乎每次支付之后，支付宝或其他 App 都会生成一个支付成功或者订单生成的通知。那么利用这个通知事件，自动打开钱迹或者其他记账应用来记账是一个很直接和容易实现的想法。另外钱迹刚好实现了 Deeplink（深度链接）的接口<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>，能够比较方便地进行自动化记账的操作。</p><p>这里把通知分为两类，其中类似支付宝比较良心地在通知文本里面提供了金额，这样我们就可以把通过正则匹配出来，直接通过钱迹的接口，一般来说只需要选择分类再点击就可以记账了；如果没有提供金额的，那么就直接打开记账页面进行手动记账。</p><p>另外本文不会像上次一样需要较多的插件和第三方应用来实现效果。</p><h3 id=通知触发-intent>通知触发 Intent</h3><p>首先我们从简单的开始，我们希望某个通知产生的时候，能够自动打开钱迹「记账」页面，从而减少打开某个应用内界面的操作。这里一是通知事件作为触发，二是发送 Intent 来打开指定页面的操作。</p><p><img src=https://cdn.sspai.com/2020/07/07/5eeacad6e96ee751dfea79eaf811a94c.jpg alt></p><h4 id=复习通知事件>复习通知事件</h4><p>如果之前接触过 Tasker 并且阅读了上一篇利用通知自动回复微信的文章，应该对 Tasker 的通知事件比较熟悉了。这里我们稍微复习一下通知事件在 Tasker 里的事件参数（Event Context）。</p><ul><li><code>%evtprm1</code> 为发送通知的应用</li><li><code>%evtprm2</code> 为通知的标题</li><li><code>%evtprm3</code> 为通知的内容文本</li></ul><p>当然在第一个例子里面不需要这么复杂，Tasker 自带的通知事件可以针对应用和标题进行过滤，这里已经足够我们使用了。</p><p>比如这里我们完整匹配了来自饿了么的标题为「您的订单已接单」的通知。关于 Tasker 的模式匹配，可以参考官方文档<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>。可以简单提一下如果没有特殊符号表示完全匹配，<code>*text*</code> 会匹配任意带 <code>text</code> 的文本，<code>/</code> 表示或，应该能满足大部分的简单的使用场景了。</p><h4 id=发送-intent>发送 Intent</h4><p>设置好触发条件之后，那么就可以执行打开页面的操作。这里使用「发送意图」的动作。</p><ul><li>包名：钱迹的包名为 <code>com.mutangtech.qianji</code></li><li>类：记账页面的 Activity 名为 <code>com.mutangtech.qianji.bill.add.AddBillActivity</code></li></ul><p>这里有聪明的小伙伴就会想知道这两个东西怎么得到的。包名比较好找，Activity 名只需要打开相应的页面，手机连接电脑之后执行下面的命令，就可以得到最新打开的 Activity 名称是什么，当然也可以从中知道包名是什么。</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>adb shell dumpsys activity recents | find <span style=color:#d20;background-color:#fff0f0>&#34;Recent #0&#34;</span>
</code></pre></div><p>试试把 <code>|</code> 的命令去掉，终端会把最近的 Activty 栈全打印出来。掌握了这个命令，就可以通过 Tasker 启动几乎任何你想要的页面，也不用采用其他插件。当然如果你想用 IntentTask 这类 Tasker 插件来简化这部分操作，也是可以的，它们只是帮你完成了这一步。</p><h3 id=通知触发-deeplink>通知触发 Deeplink</h3><p>接下来我们再稍微加深一点难度，毕竟上面的内容只是帮你节省了打开页面操作的时间，还需要手动输入金额，而输金额很麻烦。当通知里面带有金额的时候，要完成自动记账也不是难事。正好钱迹提供了 Deeplink 供自动化记账使用。</p><h4 id=deeplink-简介>Deeplink 简介</h4><p>根据官方文档，Deeplink 可以描述如下：</p><div class="notices info"><p>深层链接是指将用户直接转到应用中的特定内容的网址。在 Android 中，您可以通过添加 intent 过滤器以及从传入的 intent 提取数据来设置深层链接，以便将用户吸引到正确的 Activity。</p></div><p>在平时使用过程中，其实我们接触还挺多的，最常见的是「在 App 中打开」之类的按钮，或者各种从一个应用跳转到另一个应用某页面的按钮。简单来说，Deeplink 的 URL 里面带有页面所需要的参数，可以被应用正确处理打开页面的同时传一定的信息进去。</p><h4 id=钱迹接口>钱迹接口</h4><p>钱迹的接口文档写得比较完善了，大家可以直接看[1]。简单提一下，就是需要拼出一个这样的 URL，然后进行访问就能直接执行钱迹提供的功能：</p><ul><li>固定前缀为 <code>qianji://publicapi/addbill?</code></li><li>必须参数账单类型 <code>type</code>，比如 <code>&type=0</code> 表示支出；账单金额 <code>money</code></li><li>其他非必须参数比如 <code>catechoose</code>，等于 1 表示弹出选择分类面板</li></ul><h4 id=操作逻辑>操作逻辑</h4><p>如图实现这样的逻辑：</p><ul><li><code>%BALANCE</code> 变量匹配出通知文本 <code>%evtprm3</code> 中的数字，这里抄了一个金额的正则表达式<code>([0-9]+|[0-9]{1,3}(,[0-9]{3})\*)(.[0-9]{1,2})?</code>，网上有很多，大家自己取舍。</li><li>如果匹配到了，即 <code>If %BALANCE1 Set</code>，则通过构建 URL 来传入金额打开钱迹的分类选择面板，URL 为 <code>qianji://publicapi/addbill?&type=0&catechoose=1&money=%BALANCE1</code></li><li>如果没有匹配到，则打开记账的 Activity，正如前面所述一样发送意图。</li></ul><p><img src=https://cdn.sspai.com/2020/07/07/7d5cf12f2fdbe6be901a1e0c68975726.jpeg alt></p><h3 id=效果展示>效果展示</h3><p>因为每次支付的时候都忘记录屏，这里用 Pushbullet 测试了两类文本的通知，效果如动图所示。</p><h3 id=高级玩法>高级玩法</h3><p>用通知触发记账其实非常直观，也很有效，但是有两个缺点：</p><p>不少通知里面没有金额，甚至不产生通知（比如淘宝支付之后），那么方法就不起效果了
钱迹提供的很多丰富的参数没有利用，比如备注，分类也需要自己选择
关于无通知触发的问题，可以使用 Log Entry 来解决。Log Entry 是去年末 Tasker 更新推出的被称为 Game Changer 的功能，即可以监听 Logcat 来实现触发。具体可见 官方示例，需要使用 ADB 或 Root 授权。</p><div class="notices info"><p>本文首发于少数派，博客仅作同步。</p></div><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=http://docs.qianjiapp.com/plugin/auto_Tasker.html>http://docs.qianjiapp.com/plugin/auto_Tasker.html</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://developer.android.com/training/app-links>https://developer.android.com/training/app-links</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p><a href=https://tasker.joaoapps.com/userguide/en/matching.html>https://tasker.joaoapps.com/userguide/en/matching.html</a> <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><div class=tags><ul class=flat><li><a href=/tags/tasker>Tasker</a></li></ul></div><div id=gitalk-container></div><link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><script>const gitalk=new Gitalk({clientID:"4ccff83836edce535e3c",clientSecret:"daeca7033b9770d0f062e007477bc4d116499434",repo:"yzlnew.github.io",owner:"yzlnew",admin:["yzlnew"],distractionFreeMode:false,id:location.pathname});(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('gitalk-container').innerHTML='Gitalk comments not available by default when the website is previewed locally.';return;}
gitalk.render('gitalk-container');})();</script></div></div><div class="footer wrapper"><div class=social-links><ul class=social-media-list><li><a href=mailto:yzlnew@gmail.com title=Mail><i data-feather=mail></i></a></li><li><a href=https://github.com/yzlnew title=Github><i data-feather=github></i></a></li><li><a href=https://t.me/r0brew title=Telegram><i data-feather=message-square></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li></ul></div><nav class=copyright><div>2020 © Copyright Ye Zhiling</div></nav></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-61197619-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script>feather.replace()</script></body></html>